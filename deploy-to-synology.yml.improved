name: CI/CD - Deploy to Synology DS220+

on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main

# –û—Ç–º–µ–Ω—è–µ–º –ø—Ä–µ–¥—ã–¥—É—â–∏–µ –∑–∞–ø—É—Å–∫–∏ –ø—Ä–∏ –Ω–æ–≤–æ–º –ø—É—à–µ
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  # Job 1: –ü—Ä–æ–≤–µ—Ä–∫–∞ –∫–æ–¥–∞ (lint, build, type-check)
  ci:
    name: Code Quality Checks
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Run linter
        run: npm run lint

      - name: Run TypeScript type check
        run: npm run build

      - name: Check formatting
        run: npm run format -- --check

  # Job 2: –î–µ–ø–ª–æ–π –Ω–∞ Synology (—Ç–æ–ª—å–∫–æ –¥–ª—è main –≤–µ—Ç–∫–∏)
  deploy:
    name: Deploy to Synology
    runs-on: ubuntu-latest
    needs: ci
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Connect to Tailscale
        uses: tailscale/github-action@v2
        with:
          authkey: ${{ secrets.TAILSCALE_AUTHKEY }}

      - name: Deploy to Synology via SSH
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.SYNOLOGY_TAILSCALE_IP }}
          username: ${{ secrets.SYNOLOGY_USER }}
          key: ${{ secrets.SYNOLOGY_SSH_KEY }}
          port: ${{ secrets.SYNOLOGY_PORT }}
          timeout: 30s
          command_timeout: 15m
          script: |
            set -e  # Exit on error

            echo "üì¶ Starting deployment..."

            # –ù–∞—Å—Ç—Ä–æ–π–∫–∞ PATH
            export PATH=/usr/local/bin:/bin:/usr/bin:$PATH

            # –ü–µ—Ä–µ—Ö–æ–¥ –≤ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é –ø—Ä–æ–µ–∫—Ç–∞
            cd /volume1/docker/meme-stealer

            # –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∫–æ–¥–∞
            echo "üîÑ Pulling latest changes..."
            /bin/git pull origin main

            # –°–æ—Ö—Ä–∞–Ω—è–µ–º —Å—Ç–∞—Ä—ã–π –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä –¥–ª—è rollback
            OLD_CONTAINER_ID=$(/usr/local/bin/docker ps -q -f name=meme-stealer)

            # –û—Å—Ç–∞–Ω–æ–≤–∫–∞ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞
            echo "üõë Stopping container..."
            /usr/local/bin/docker-compose down

            # –°–±–æ—Ä–∫–∞ —Å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ–º BuildKit –∏ –∫—ç—à–∞
            echo "üèóÔ∏è  Building new image..."
            DOCKER_BUILDKIT=1 /usr/local/bin/docker-compose build

            # –ó–∞–ø—É—Å–∫ –Ω–æ–≤–æ–≥–æ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞
            echo "üöÄ Starting new container..."
            /usr/local/bin/docker-compose up -d

            # –ñ–¥–µ–º –∑–∞–ø—É—Å–∫–∞ –∏ –ø—Ä–æ–≤–µ—Ä—è–µ–º healthcheck
            echo "‚è≥ Waiting for container to be healthy..."
            sleep 10

            # –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç–∞—Ç—É—Å–∞ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞
            if /usr/local/bin/docker ps | grep -q meme-stealer; then
              echo "‚úÖ Container is running!"
              /usr/local/bin/docker-compose logs --tail=50
            else
              echo "‚ùå Container failed to start!"
              /usr/local/bin/docker-compose logs --tail=100
              exit 1
            fi

            # –û—á–∏—Å—Ç–∫–∞ —Å—Ç–∞—Ä—ã—Ö –æ–±—Ä–∞–∑–æ–≤
            echo "üßπ Cleaning up old images..."
            /usr/local/bin/docker image prune -f

      - name: Notify on success
        if: success()
        run: |
          echo "‚úÖ Deployment to Synology DS220+ completed successfully!"
          echo "üì¶ Version: ${{ github.sha }}"
          echo "üë§ Author: ${{ github.actor }}"

      - name: Notify on failure
        if: failure()
        run: |
          echo "‚ùå Deployment failed!"
          echo "üìù Check logs on Synology for details"
          echo "üîÑ Consider manual rollback if needed"
