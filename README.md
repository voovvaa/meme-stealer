# tgchelper-next

Телеграм-клиент на Node.js, который авторизуется через MTProto, подписывается на заданные каналы с мемами, отбрасывает рекламные сообщения и копирует «чистые» картинки из чужих каналов в целевой публичный канал.

## Быстрый старт
1. Установите [Node.js](https://nodejs.org/) версии 20 или выше.
2. Скопируйте `.env.example` в `.env` и заполните переменные (см. ниже).  
3. Установите зависимости: `npm install`.
4. Запустите в разработке: `npm run dev`.
5. Соберите прод-артефакты: `npm run build`.

## Переменные окружения
- `API_ID` и `API_HASH` — значения из [my.telegram.org](https://my.telegram.org).  
- `PHONE_NUMBER` — номер телефона аккаунта Telegram (в международном формате).  
- `TELEGRAM_PASSWORD` — пароль двухфакторной аутентификации; оставьте пустым, если не используется.  
- `TARGET_CHANNEL_ID` — ID или @username канала, куда будут отправляться очищенные медиа.  
- `SOURCE_CHANNEL_IDS` — список ID/@username каналов-источников через запятую.  
- `AD_KEYWORDS` — ключевые слова (через запятую), по которым сообщение считается рекламой.  
- `LOG_LEVEL` — уровень логирования pino (`info`, `debug`, `trace`, ...).  
- `SESSION_STORAGE_PATH` — путь до файла со строкой сессии (`StringSession`).
- `MEME_DB_PATH` — путь до файла SQLite, где сохраняются хэши опубликованных медиа для защиты от дублей.

Файл сессии создаётся автоматически после успешного входа. Убедитесь, что каталог существует или доступен для создания и добавлен в `.gitignore`.

## Архитектура
- `src/core` — конфигурация (`env.ts`) и pino-логгер.  
- `src/features/telegram` — инициализация MTProto-клиента, обработчики постов, фильтры, локальное хранение сессии.  
- `src/utils` — вспомогательные утилиты.  
- `src/main.ts` — точка входа.

Клиент использует GramJS (MTProto). После авторизации (номер телефона + одноразовый код) бот подписывается на события `NewMessage` для whitelisted-каналов, проверяет текст/подписи на рекламные ключевые слова и загружает медиа сообщений, а затем заново публикует их в целевом канале без использования механизма пересылки.

Для предотвращения повторов каждое изображение хешируется (`sha256`), и хэши сохраняются в SQLite (`MEME_DB_PATH`). Если в будущем приходит медиа с таким же хэшем, оно пропускается и не отправляется повторно.

> ⚠️ Аккаунт, под которым запускается клиент, должен быть подписан на каналы-источники и иметь права публикации в целевом канале (обычно достаточно быть администратором или редактором). Храните каталоги `sessions/` (сессия + база) на постоянном носителе, например, пробрасывайте volume при запуске контейнера.

## Качество и CI/CD
- `npm run lint` — проверка ESLint (`@typescript-eslint`, `import`, `unused-imports`).
- `npm run format` — форматирование Prettier.
- CI (`.github/workflows/deploy.yml`) запускает lint → build на каждый push/PR. На ветке `main` запускается Docker Buildx с публикацией образа (требуются секреты реестра).

## Docker

```bash
docker build -t tgchelper-next .
docker run \
  -v "$(pwd)/sessions:/app/sessions" \
  --env-file .env \
  tgchelper-next
```

Каталог `sessions/` содержит файл сессии MTProto и базу `memes.sqlite`, поэтому его обязательно монтируем как volume.

## Расширение
- Добавляйте новые фильтры в `src/features/telegram/handlers`.  
- Для сложной бизнес-логики выносите вспомогательный код в `src/utils` или новые модули `src/features`.  
- Планируя интеграцию с внешними сервисами, создавайте отдельные адаптеры и покрывайте их тестами.  
- Для улучшения дедупликации постов используйте сессию (например, храните последние message_id).
